<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="R.W. Oldford" />

<meta name="date" content="2022-02-06" />

<title>Smoothers and Bone Mineral Density</title>

<script src="data:application/javascript;base64,Ly8gUGFuZG9jIDIuOSBhZGRzIGF0dHJpYnV0ZXMgb24gYm90aCBoZWFkZXIgYW5kIGRpdi4gV2UgcmVtb3ZlIHRoZSBmb3JtZXIgKHRvCi8vIGJlIGNvbXBhdGlibGUgd2l0aCB0aGUgYmVoYXZpb3Igb2YgUGFuZG9jIDwgMi44KS4KZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGZ1bmN0aW9uKGUpIHsKICB2YXIgaHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCJkaXYuc2VjdGlvbltjbGFzcyo9J2xldmVsJ10gPiA6Zmlyc3QtY2hpbGQiKTsKICB2YXIgaSwgaCwgYTsKICBmb3IgKGkgPSAwOyBpIDwgaHMubGVuZ3RoOyBpKyspIHsKICAgIGggPSBoc1tpXTsKICAgIGlmICghL15oWzEtNl0kL2kudGVzdChoLnRhZ05hbWUpKSBjb250aW51ZTsgIC8vIGl0IHNob3VsZCBiZSBhIGhlYWRlciBoMS1oNgogICAgYSA9IGguYXR0cmlidXRlczsKICAgIHdoaWxlIChhLmxlbmd0aCA+IDApIGgucmVtb3ZlQXR0cmlidXRlKGFbMF0ubmFtZSk7CiAgfQp9KTsK"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<link rel="stylesheet" href="data:text/css,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" type="text/css" />




</head>

<body>




<h1 class="title toc-ignore">Smoothers and Bone Mineral Density</h1>
<h4 class="author">R.W. Oldford</h4>
<h4 class="date">2022-02-06</h4>


<div id="TOC">
<ul>
<li><a href="#illustrates">Illustrates:</a></li>
<li><a href="#the-data-bone-mineral-density">The data: Bone mineral density</a></li>
<li><a href="#the-scatterplot">The scatterplot</a></li>
<li><a href="#histogram">Histogram</a></li>
<li><a href="#panning-and-brushing">Panning and brushing</a></li>
<li><a href="#adding-a-dynamically-changing-smooth">Adding a (dynamically changing) smooth</a></li>
<li><a href="#a-smooth-as-a-running-linear-fit">A smooth as a running linear fit</a></li>
</ul>
</div>

<div id="illustrates" class="section level3">
<h3>Illustrates:</h3>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(loon)</span></code></pre></div>
<ol style="list-style-type: decimal">
<li>linked scatterplots</li>
<li>panning and zooming</li>
<li>creating new interactions through bindings</li>
</ol>
</div>
<div id="the-data-bone-mineral-density" class="section level2">
<h2>The data: Bone mineral density</h2>
<p>The data consists of measurements of spinal bone mineral density. Several such measurements were taken from 261 North American adolescents over a few years. The entire dataset is called <code>bone</code> and can be found in the <code>R</code> package <code>loon.data</code>.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">data</span>(bone, <span class="at">package =</span> <span class="st">&quot;loon.data&quot;</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(bone)</span></code></pre></div>
<p>As can be seen, there are five variates. The <code>idnum</code> uniquely identifies each of the 261 adolescents (N.B. these are not numbered 1 to 261), <code>sex</code> identifies their sex, and <code>ethnic</code> their “ethnicity/race”. The response variate of interest is <code>rspnbmd</code> which is a relative measure of spinal bone mineral density determined as the ratio of the difference in bone mineral density as measured on two consecutive visits divided by their average. Similarly, the explanatory variate <code>age</code> is the average of the adolescent’s age in years on those two visits.</p>
<p>In this vignette we investigate the fit of smoothing splines to this data.</p>
</div>
<div id="the-scatterplot" class="section level2">
<h2>The scatterplot</h2>
<p>To begin, execute the following code:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The plot</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>x <span class="ot">&lt;-</span> bone<span class="sc">$</span>age</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> bone<span class="sc">$</span>rspnbmd</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="co">#  A scatterplot</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="fu">l_plot</span>(x, y,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>            <span class="at">color=</span><span class="st">&quot;darkgrey&quot;</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>            <span class="at">xlabel=</span><span class="st">&quot;age&quot;</span>, <span class="at">ylabel=</span><span class="st">&quot;rspnbmd&quot;</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>            <span class="at">showGuides =</span> <span class="cn">TRUE</span>, <span class="at">showScales =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>            <span class="at">itemLabel =</span> <span class="fu">paste0</span>(<span class="st">&quot;IDnum = &quot;</span>, bone<span class="sc">$</span>idnum, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>, </span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>                               bone<span class="sc">$</span>sex, <span class="st">&quot;</span><span class="sc">\n</span><span class="st">&quot;</span>, </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>                               <span class="st">&quot;Age: &quot;</span>, bone<span class="sc">$</span>age),</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>            <span class="at">showItemLabels =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">linkingGroup=</span><span class="st">&quot;Bone density&quot;</span>,</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="st">&quot;Spinal bone mineral density (rspnbmd)&quot;</span>)</span></code></pre></div>
<p>Two windows will have appeared once the above code has been executed. One is the plot <code>p</code>, the other the <strong>inspector</strong> of the plot <code>p</code>.</p>
<p>The plot is interactive. Hovering the mouse over a point in the plot, for example, will pop up the <code>itemLabel</code> for that point. Scrolling on mouse wheel (or equivalent) over the plot <strong>zooms</strong> in (or out) on the plot; note that the zoom is centred at the mouse position. For <strong>horizontal zooming</strong> only, hold the “control” key down while scrolling; for <strong>vertical zooming</strong> only hold the “alt” (or <code>cmd</code> on a Mac) key while scrolling.</p>
<p>Zoom in anywhere on the plot. Notice that the <strong>inspector</strong> displays a miniature version of the whole plot as its <strong>World View</strong> at the top of its display. The plot is bounded in the World View by a grey rectangle and the region of the plot that is displayed is shown as a brighter region bounded by a black rectangle. This bright display region can be grabbed by clicking (and holding depressed) the left (or primary) mouse button. Moving the mouse around while keeping the left button depressed moves the bright region in the inspector which in turn cause the display in the plot to update accordingly. In this way, the inspector World View can be used to <strong>pan</strong> the entire display. Alternatively, <strong>panning</strong> may also be effected by right (or secondary) button clicking on the interior of the plot, holding that mouse button down and moving the mouse. In the inspector the region moves with the mouse, in the plot the background does.</p>
<p>Panning and zooming can occur either on the inspector plot or on the plot itself. In either case, the panning or zooming is constrained to the horizontal when the control key is held at the same time and to the vertical when the <code>alt</code> or <code>cmd</code> key is held.</p>
<p>To get the displayed scatterplot back to its original scale, in the inspector click on <code>scale to: plot</code>. Alternatively the same effect can be hand programmatically as <code>l_scaleto_plot(p)</code>. (To scale to all layers in the plot use <code>l_scaleto_world(p)</code>.)</p>
<p>See <code>help(l_plot)</code> for more details and examples.</p>
<p>In the inspector window, immediately below the World View there are several <strong>tabs</strong>, the first of which is the <strong>Analysis tab</strong>. The first subsection of the analysis tab contains plot attributes. The values here were determined when the plot <code>p</code> was created according to the values of the arguments given to <code>l_plot(...)</code>. These can be changed in the inspector by toggling the check boxes.</p>
<p>The complete set of arguments that could have been used at the time of creation can be had by querying the plot <code>p</code> as <code>names(l_info_states)</code>. The values can also be accessed and changed programmatically for example as in</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>p[<span class="st">&quot;showItemLabels&quot;</span>]</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>p[<span class="st">&quot;showGuides&quot;</span>]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>p[<span class="st">&quot;swapAxes&quot;</span>] <span class="ot">&lt;-</span> <span class="cn">TRUE</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>p[<span class="st">&quot;swapAxes&quot;</span>] <span class="ot">&lt;-</span> <span class="cn">FALSE</span></span></code></pre></div>
<p>The vertical variate, <code>rspnbmd</code>, measured the <em>change</em> in spinal bone mineral density. Anything above zero indicates an increase, anything below a decrease; the magnitude is the rate of change in density. It might be of interest, then, to add a horizontal line to the plot at zero. This is accomplished by <strong>layering a line</strong> on the plot <code>p</code> as follows:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>axis <span class="ot">&lt;-</span> <span class="fu">l_layer_line</span>(p,</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>                     <span class="at">x=</span><span class="fu">extendrange</span>(x, <span class="at">f=</span><span class="fl">0.5</span>), <span class="at">y=</span><span class="fu">c</span>(<span class="dv">0</span>,<span class="dv">0</span>),</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>                     <span class="at">label=</span><span class="st">&quot;axis&quot;</span>, <span class="at">linewidth=</span><span class="dv">2</span>,</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>                     <span class="at">color =</span> <span class="st">&quot;black&quot;</span>,</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>                     <span class="at">dash=</span><span class="fu">c</span>(<span class="dv">10</span>,<span class="dv">10</span>),</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>                     <span class="at">index=</span><span class="st">&quot;end&quot;</span>)   <span class="co"># last argument places axis behind other layers</span></span></code></pre></div>
<p>This “axis” can be turned on and off via the inspector or programmatically. On the inspector, click on the <strong>Layers</strong> tab. The layers appear in a list ordered from top to bottom in the inspector in the order in which they are displayed in the plot. The <code>axis</code> appears below the Scatterplot and hence is displayed behind the points.</p>
<p>Selecting the axis, the up and down buttons at the bottom of the list allow the axis to be placed above or below the Scatterplot. The axis (or Scatterplot) can be moved up or down in the display. Either can be made (temporarily) invisible by clicking on the icon showing a cartoon eye with a stroke through it and made visible again by clicking on the cartoon eye. Try it.</p>
<p>The axis (or any other layer, e.g. the Scatterplot), could be removed entirely with the minus sign. Don’t do this right now; click on the “Analysis” tab instead.</p>
</div>
<div id="histogram" class="section level2">
<h2>Histogram</h2>
<p>A histogram can be constructed in the same way as for <em>numeric</em> values. Now, because <code>sex</code> is a <code>factor</code>, the result is essentially a simple bar plot with a layer labelling the bars by the corresponding <code>sex</code>:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="fu">l_hist</span>(bone<span class="sc">$</span>sex, </span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>            <span class="at">xlabel =</span> <span class="st">&quot;sex&quot;</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>            <span class="at">linkingGroup=</span><span class="st">&quot;Bone density&quot;</span>,</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>            <span class="at">title =</span> <span class="st">&quot;Sex&quot;</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>            )</span></code></pre></div>
<p>Note that the inspector now shows the histogram (i.e. barplot) in the World View and that the plot section of the Analysis now has options peculiar to a histogram.</p>
<p>The histogram and the scatterplot both have the same <code>linkingGroup</code> “Bone density” and the inspector shows that the 2 plots are <strong>linked</strong>. Selecting the left most bar of the histogram highlights all of the females in both plots. Switching back and forth between the two bars while observing the scatterplot shows that the pattern for males seems to be shifted slightly to the right of those for the females.</p>
<p>Similarly, selecting any point in the scatterplot causes a corresponding slice of the bar in which it appears in the histogram to be highlighted.</p>
<p><strong>Multiple selections</strong> can made by holding the <strong>shift key</strong> while selecting. Alternatively, clicking on the background, holding the mouse button down while <strong>sweeping</strong> out a rectangle will highlight all data objects which intersect with the rectangle.</p>
<p>Once selected, the display of the points can be <strong>modified</strong> by clicking on any of the colour patches to change their colour, or the glyph symbols to change the shape of points, the <code>-</code> and <code>+</code> signs to change size, and the <code>deactivate</code> (and <code>reactivate</code>) to remove the points from (or return them to) the display.</p>
<p>Try selecting the points in the scatterplot and making various modifications. Note that because the displays are linked the changes are effected (where sensible) in both displays. Note that once the points have been coloured it is also possible to select points by colour from the inspector.</p>
<p>Note that with <strong>shift sweeping</strong> (sweeping while the shift key pressed), multiple selections can be made. Couple this with <code>dynamic</code> selection that <code>deselect</code>s or <code>invert</code>s and very complex patterns of selected points can be constructed.</p>
<p>To return the displays to their original configuration, from the inspector reactivate all of the points, then select <code>all</code> from the <code>Select</code> part of the <code>Analysis</code> panel, then select the filled circle glyph shape, and a single colour from those available (selecting the colour <code>+</code> will pop up a colour picker) To return to the original colour execute <code>p[&quot;color&quot;] &lt;- &quot;darkgrey&quot;</code>.</p>
</div>
<div id="panning-and-brushing" class="section level2">
<h2>Panning and brushing</h2>
<p>A second scatterplot could display other variates. For example, plotting the age versus the patient ID number gives:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>p2 <span class="ot">&lt;-</span> <span class="fu">l_plot</span>(bone<span class="sc">$</span>idnum, bone<span class="sc">$</span>age,</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>             <span class="at">xlabel=</span><span class="st">&quot;idnum&quot;</span>, <span class="at">ylabel=</span><span class="st">&quot;age&quot;</span>,</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">linkingGroup=</span><span class="st">&quot;Bone density&quot;</span>,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">title =</span> <span class="st">&quot;ID numbers and age&quot;</span>)</span></code></pre></div>
<p>Ideally this plot would look like fairly uniform scatter. Assuming that <code>idnum</code> was assigned with recruitment there are some patterns. In the middle of the <code>idnum</code> range, for example, there appears to be a preponderance of older ages followed immediately by a preponderance of younger ages.</p>
<p>We might investigate how the change in <code>idnum</code> from low to high manifests itself in the relationship between bone mineral density and age by <strong>brushing</strong> the points in <code>p2</code> and observing the effect in <code>p</code>. To do this, click on <code>p2</code> so that the inspector has <code>p2</code> as its focus (appears in the inspector World View). In the inspector <code>Select</code> panel (on the <code>Analysis</code> tab) select <code>by: brushing</code>. A rectangle will appear in <code>p2</code>; this is the <strong>brush</strong>.</p>
<p>Since we are interested in observing the relationship between bone density and age <strong>conditional</strong> on <code>idnum</code>, we need to shape the brush to be a long, relatively thin, vertical brush. The brush is reshaped by selecting the box in its lower-right corner and moving it until you get the shape desired. The brush will maintain that shape (unique to <code>p2</code>) until it is again changed.</p>
<p>Now clicking anywhere in <code>p2</code> will have the brush follow the mouse (while the mouse button is depressed) and highlight all points located within the rectangle. For example beginning at the lower left corner of the scatterplot and moving the mouse left to right horizontally, a tall narrow brush should select points with the same (or nearly the same) <code>idnum</code> and the relationship between bone density and age as the <code>idnum</code> increases can be seen in the original scatterplot <code>p</code>.</p>
<p>To have a <strong>sticky brush</strong>, or have the brush accumulate the selections brushed, simply use the shift key as before. Again the nature of the brushing can be changed by selecting different <code>dynamic</code> modes. To <strong>turn off brushing</strong> select <code>sweeping</code> in the <code>Select</code> panel of the inspector for <code>p2</code>.</p>
<p><strong>Zooming</strong> and <strong>panning</strong> in <code>p2</code> also reveals some interesting structure. Horizontally zoom on <code>p2</code> until each <code>idnum</code> is well separated. Then horizontally pan across the <code>idnum</code>s (most easily done from the inspector World View).</p>
<p>It becomes easy to see that each subject (<code>idnum</code>) appears one, two, or three times. Because each value is the <em>change</em> in bone density (and so must be calculated on the basis of two visits) this means that each person had two, three, or four visits. Checking the <code>scales</code> and <code>guides</code> boxes of the plot panel in the inspector and panning reveals also that for every <code>idnum</code>, the difference in <code>age</code> are is at most 2 and does not appear to span more than 3 years. Together, this suggests that the data may have been collected in a single time period of about 3 years. Moreover, the bulk of those <code>idnums</code> which have three entries occur early in the order of <code>idnum</code>, possibly meaning early in the recruitment.</p>
</div>
<div id="adding-a-dynamically-changing-smooth" class="section level2">
<h2>Adding a (dynamically changing) smooth</h2>
<p>To summarize the relationship, first add a straight line fitted by <code>lm()</code> using the function <code>l_layer_smooth()</code> and the method <code>&quot;lm&quot;</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">l_layer_smooth</span>(p, <span class="at">method =</span> <span class="st">&quot;lm&quot;</span>, </span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>               <span class="at">label =</span> <span class="st">&quot;straight line fit&quot;</span>,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">linecolor =</span> <span class="st">&quot;firebrick&quot;</span>,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>               <span class="at">linedash =</span> <span class="fu">c</span>(<span class="dv">4</span>,<span class="dv">4</span>),</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>               <span class="at">linewidth =</span> <span class="dv">4</span>)</span></code></pre></div>
<p>The same function could also be used to add a smooth (default <code>method = &quot;loess&quot;</code>). Instead, we will add a smoothing spline from the <code>splines</code> package and use it to fit bone mineral density as a function of time (i.e. to the data of <code>p</code>).</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(splines)</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a smoothing spline</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>fitsmooth <span class="ot">&lt;-</span> <span class="fu">smooth.spline</span>(x, y, <span class="at">df=</span><span class="dv">5</span>)</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>xOrder <span class="ot">&lt;-</span> <span class="fu">order</span>(x)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>smooth <span class="ot">&lt;-</span> <span class="fu">l_layer_line</span>(p,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>                       <span class="at">x =</span> x[xOrder],</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>                       <span class="at">y =</span> <span class="fu">predict</span>(fitsmooth, <span class="at">x =</span> x[xOrder])<span class="sc">$</span>y,</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>                       <span class="at">label =</span> <span class="st">&quot;smooth fit&quot;</span>, </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>                       <span class="at">linewidth =</span> <span class="dv">4</span>,</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>                       <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>)</span></code></pre></div>
<p>Unlike the straight line fit, the smooth shows that the change in spinal bone mineral density rises up to about 12 years of age and then declines thereafter ultimately hitting zero.</p>
<p>Of course this is the aggregate behaviour, over both sexes. It might be interesting to see how this changes for males and for females. We could do this by adding a smooth for each sex but there may be other subgroups of the data that we would like to investigate. To that end we introduce a <strong>dynamic update</strong> to the smooth.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="do">## Define the update function</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>updateSmooth <span class="ot">&lt;-</span> <span class="cf">function</span>(myPlot, minpts, df, <span class="at">color=</span><span class="st">&quot;blue&quot;</span>) {</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Get the values for x and y from the plot</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  <span class="do">##</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  <span class="do">## For x</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  xnew <span class="ot">&lt;-</span> myPlot[<span class="st">&quot;xTemp&quot;</span>]</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(xnew) <span class="sc">==</span> <span class="dv">0</span>) {xnew <span class="ot">&lt;-</span> myPlot[<span class="st">&quot;x&quot;</span>]}</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  <span class="do">## For y</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  ynew <span class="ot">&lt;-</span> myPlot[<span class="st">&quot;yTemp&quot;</span>]</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(ynew) <span class="sc">==</span> <span class="dv">0</span>) {ynew <span class="ot">&lt;-</span> myPlot[<span class="st">&quot;y&quot;</span>]}</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Now **only** use the active selected points to construct the smooth</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  sel <span class="ot">&lt;-</span> myPlot[<span class="st">&quot;selected&quot;</span>] <span class="sc">&amp;</span> myPlot[<span class="st">&quot;active&quot;</span>]</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  xnew <span class="ot">&lt;-</span> xnew[sel]</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  ynew <span class="ot">&lt;-</span> ynew[sel]</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  Nsel <span class="ot">&lt;-</span> <span class="fu">sum</span>(sel)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (Nsel <span class="sc">&gt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> <span class="fu">diff</span>(<span class="fu">range</span>(xnew)) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Find the range of the selected x values</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>    xrng <span class="ot">&lt;-</span> <span class="fu">extendrange</span>(xnew)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>    xvals.temp <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from=</span><span class="fu">min</span>(xrng),</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>                      <span class="at">to=</span><span class="fu">max</span>(xrng), </span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>                      <span class="at">length.out=</span><span class="dv">100</span>)</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Redo our smooth **only** if we have enough points</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ((Nsel <span class="sc">&gt;</span> minpts) <span class="sc">&amp;</span> (minpts <span class="sc">&gt;</span> (df <span class="sc">+</span> <span class="dv">1</span>))){</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>      fit.temp <span class="ot">&lt;-</span> <span class="fu">smooth.spline</span>(xnew, ynew, <span class="at">df=</span>df)</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>      ypred.temp <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit.temp,<span class="at">x=</span>xvals.temp)<span class="sc">$</span>y</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>      <span class="do">## update the smooth</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (smooth <span class="sc">%in%</span> <span class="fu">l_layer_ids</span>(myPlot)) {</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>        <span class="do">## reconfigure the smooth with new data</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        <span class="fu">l_configure</span>(smooth, <span class="at">x=</span>xvals.temp, <span class="at">y=</span>ypred.temp)</span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>        <span class="do">## If the smooth has been deleted, then we recreate it </span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>        <span class="do">## (N.B. in the global environment)</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>        smooth <span class="ot">&lt;&lt;-</span>  <span class="fu">l_layer_line</span>(myPlot,</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">x=</span>xvals.temp, </span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">y=</span>ypred.temp,</span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">label=</span><span class="st">&quot;smooth fit&quot;</span>, </span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">linewidth=</span><span class="dv">4</span>,</span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">color =</span> color)</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>      } </span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Update the tcl language&#39;s event handler</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tcl</span>(<span class="st">&quot;update&quot;</span>, <span class="st">&quot;idletasks&quot;</span>)</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Now, we would like to have this update called whenever any interesting change in state occurs. There are numerous such possible states (see <code>names(p)</code>, <code>names(l_info_states(p))</code>, or <code>l_help(&quot;learn_R_bind&quot;)</code> ). Here we bind an anonymous function of no arguments to be called whenever there is any change in the values of <code>p</code> contained in its <code>selected</code> state. This means that the function is called if any point in <code>p</code> is selected or deselected.</p>
<p>Note also that the smooth is based on the <strong>temporary</strong> <code>x</code> and <code>y</code> values. Points in a <strong>scatterplot may be moved</strong> by selecting them with the control button depressed (as well as shift for multiple selection). Alternatively, <strong>selected points may be pushed together, distributed vertically or horizontally, arranged on a grid, or jittered</strong> by selecting the corresponding <code>move</code> button from the <code>Modify</code> panel of the inspector. All points can be returned to their original position by clicking the recover button</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we &quot;bind&quot; the anonymous to the named state changes of p</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">l_bind_state</span>(p, <span class="fu">c</span>(<span class="st">&quot;selected&quot;</span>),</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>             <span class="cf">function</span>() {<span class="fu">updateSmooth</span>(p, <span class="dv">10</span>, <span class="dv">5</span>, <span class="st">&quot;blue&quot;</span>)}</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Now go to the histogram and select first the female bar, then the make bar, and watch how the smoothing spline adapts to the sex. Clearly, females have greater changes in spinal bone mineral density at a younger age than do males. No doubt this is a consequence of the different ages at which girls and boys sexually mature.</p>
<p>Brushing any set of points, from any of the linked plots will now cause the smooth function to automatically recalculate and redisplay. In this way one might pursue, for example how the smooth changes over subsets of <code>idnum</code> values.</p>
<p>Note that the points must be both active and selected. We could, for example, focus on how the smooth changes <em>only for any subset of females</em> by first deactivating all males and then brushing the subset of the females.</p>
<p>Note that the states that are bound can be seen as <code>l_bind_state_ids(p)</code> and deleted using <code>l_bind_state_delete(p, &quot;stateBinding0&quot;)</code>.</p>
</div>
<div id="a-smooth-as-a-running-linear-fit" class="section level2">
<h2>A smooth as a running linear fit</h2>
<p>Linear smoothers can be thought of as the connected predicted values of locally fitted linear models having weights which are maximal at the point <span class="math inline">\(x\)</span> where the prediction is being made and which drop off to zero for <span class="math inline">\(x\)</span> values far away from it.</p>
<p>To illustrate this we add a straight line to the scatterplot that is fitted to the data via weighted least squares using Gaussian weights. For any collection of <span class="math inline">\(x\)</span> values, the prediction will be made at their median.</p>
<p>The Gaussian weight function will be centred at the median:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>GaussWt <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get an estimated standard deviation</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  h <span class="ot">&lt;-</span> <span class="fu">diff</span>(<span class="fu">range</span>(x))<span class="sc">/</span><span class="dv">4</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Centre at median</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  xloc <span class="ot">&lt;-</span> <span class="fu">median</span>(x)</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Gaussian density</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">dnorm</span>(x, <span class="at">mean=</span>xloc, <span class="at">sd=</span>h)</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Use these weights to fit a line to the data.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit a local line using some Gaussian weights.</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Prediction will be at the median of x, fit by</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="do">### weights that decrease with x&#39;s</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># distance from the median.</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>fitwls <span class="ot">&lt;-</span> <span class="fu">lm</span>(y <span class="sc">~</span> x, <span class="at">weights=</span><span class="fu">GaussWt</span>(x))</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>linewls <span class="ot">&lt;-</span> <span class="fu">l_layer_line</span>(p, </span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>                        <span class="at">x=</span>x,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>                        <span class="at">y=</span><span class="fu">predict</span>(fitwls,</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>                                  <span class="at">newdata=</span><span class="fu">data.frame</span>(<span class="at">x=</span>x)),</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>                        <span class="at">label=</span><span class="st">&quot;Fitted line&quot;</span>,</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>                        <span class="at">linewidth=</span><span class="dv">4</span>,</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>                        <span class="at">color =</span> <span class="st">&quot;blue&quot;</span>)</span></code></pre></div>
<p>Clicking on the <code>Layers</code> tab in the inspector shows the scatterplot, the axis, the smooth fit, and the Gaussian weight straight line. Select the last of these and render it invisible by clicking on that button, or, by programmatically by executing the following.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">l_layer_hide</span>(p, smooth)</span></code></pre></div>
<p>Now make the fitted line update to fit only the selected points.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>updateLocalLine <span class="ot">&lt;-</span> <span class="cf">function</span>(myPlot, minpts, df, <span class="at">volor=</span><span class="st">&quot;blue&quot;</span>) {</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Get the values for x and y from the plot</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="do">## For x</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>  xnew <span class="ot">&lt;-</span> myPlot[<span class="st">&quot;xTemp&quot;</span>]</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(xnew) <span class="sc">==</span> <span class="dv">0</span>) {xnew <span class="ot">&lt;-</span> myPlot[<span class="st">&quot;x&quot;</span>]}</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>  <span class="do">## For y</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  ynew <span class="ot">&lt;-</span> myPlot[<span class="st">&quot;yTemp&quot;</span>]</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="fu">length</span>(ynew) <span class="sc">==</span> <span class="dv">0</span>) {ynew <span class="ot">&lt;-</span> myPlot[<span class="st">&quot;y&quot;</span>]}</span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Now **only** use the active selected points to construct the smooth</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>  sel <span class="ot">&lt;-</span> myPlot[<span class="st">&quot;selected&quot;</span>] <span class="sc">&amp;</span> myPlot[<span class="st">&quot;active&quot;</span>]</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>  xnew <span class="ot">&lt;-</span> xnew[sel]</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>  ynew <span class="ot">&lt;-</span> ynew[sel]</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>  Nsel <span class="ot">&lt;-</span> <span class="fu">sum</span>(sel)</span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (Nsel <span class="sc">&gt;</span> <span class="dv">3</span> <span class="sc">&amp;</span> <span class="fu">diff</span>(<span class="fu">range</span>(xnew)) <span class="sc">&gt;</span> <span class="dv">0</span>) {</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    xrng <span class="ot">&lt;-</span> <span class="fu">extendrange</span>(xnew)</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    xvals.temp <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="at">from=</span><span class="fu">min</span>(xrng),</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>                      <span class="at">to=</span><span class="fu">max</span>(xrng), </span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>                      <span class="at">length.out=</span><span class="dv">100</span>)</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>    <span class="do">## Redo line if more than two points.</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (Nsel<span class="sc">&gt;</span> <span class="dv">2</span>) {</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>      fit.wls <span class="ot">&lt;-</span>  <span class="fu">lm</span>(ynew <span class="sc">~</span> xnew, <span class="at">weights=</span><span class="fu">GaussWt</span>(xnew))</span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>      ywls.temp <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit.wls,</span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>                           <span class="at">newdata=</span><span class="fu">data.frame</span>(<span class="at">xnew=</span>xvals.temp))</span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>      <span class="do">## update the fit</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> (linewls <span class="sc">%in%</span> <span class="fu">l_layer_ids</span>(myPlot)) {</span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">l_configure</span>(linewls, <span class="at">x=</span>xvals.temp, <span class="at">y=</span>ywls.temp)</span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>        <span class="do">## If it&#39;s been deleted, we recreate it (in the global environment).</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>        linewls <span class="ot">&lt;&lt;-</span> <span class="fu">l_layer_line</span>(myPlot,</span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">x=</span>xvals.temp,</span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">y=</span><span class="fu">predict</span>(fitwls,</span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>                                           <span class="at">newdata=</span><span class="fu">data.frame</span>(<span class="at">x=</span>xvals.temp)</span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>                                 ),</span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">label=</span><span class="st">&quot;GaussWt at median line&quot;</span>, </span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">linewidth=</span><span class="dv">4</span>,</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">color=</span><span class="st">&quot;blue&quot;</span></span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>      }</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>  <span class="do">## Update the tcl language&#39;s event handler</span></span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">tcl</span>(<span class="st">&quot;update&quot;</span>, <span class="st">&quot;idletasks&quot;</span>)</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>And now bind this update function to change in <code>p</code> of either the <code>select</code> or the <code>active</code> states.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Here we &quot;bind&quot; the anonymous to the named state changes of p</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="fu">l_bind_state</span>(p, <span class="fu">c</span>(<span class="st">&quot;active&quot;</span>,<span class="st">&quot;selected&quot;</span>),</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>             <span class="cf">function</span>() {<span class="fu">updateLocalLine</span>(p, <span class="dv">10</span>, <span class="dv">5</span>, <span class="st">&quot;blue&quot;</span>)}</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Selecting the male or female sex in the histograms will show the weighted least squares line for that sex. Brushing a tall thin vertical brush on <code>p2</code> will show how the fitted line changes (or not) as the similar <code>idnum</code>s change. But most interestingly, and the object of this lesson, is to brush <code>p2</code> with a short very wide brush so that the <code>age</code> can be kept roughly constant. As <code>age</code> increases or decreases, the line segment changes its fit: both in height and in slope. The smooth seen earlier is essentially the connected midpoints of these line segments.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
